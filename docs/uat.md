# 用户验收文档 (UAT - User Acceptance Testing)

**项目名称**: MCP Database SDK  
**版本**: v1.0  
**创建日期**: 2024-01-07  
**文档状态**: ⏳ 待评审

---

## 1. 验收测试概述

### 1.1 验收目标
验证 MCP Database SDK 在实际使用场景中满足产品需求文档 (PRD) 中定义的所有功能和质量要求。

### 1.2 验收标准
- 所有 P0 功能需求完整实现
- 所有 P1 功能需求正常工作
- 性能指标达到 PRD 要求
- 安全机制有效防护
- 文档完整可用

### 1.3 验收角色
- **AI Agent (主要用户)**: 通过 MCP 协议使用 SDK
- **开发者 (次要用户)**: 直接使用 Python SDK
- **系统管理员**: 配置和部署 SDK

---

## 2. 功能验收场景

### 2.1 基础 CRUD 操作验收

#### UAT-001: 数据插入验收 ⏳ 待验收
**场景描述**:  
作为 AI Agent，我需要向数据库插入用户数据。

**前置条件**:
- DATABASE_URL 已配置
- ENABLE_INSERT=true
- 目标表已存在

**测试步骤**:
1. 调用 `database_insert` 工具
2. 提供表名 "users" 和数据 `{"name": "Alice", "age": 25}`
3. 观察返回结果

**预期结果**:
```json
{
  "success": true,
  "inserted_count": 1,
  "inserted_ids": ["<generated_id>"]
}
```

**验收标准**:
- ✅ 数据成功插入数据库
- ✅ 返回正确的插入 ID
- ✅ 操作耗时 < 100ms (本地数据库)

**状态**: ⏳ 待验收

---

#### UAT-002: 数据查询验收 ⏳ 待验收
**场景描述**:  
作为 AI Agent，我需要查询年龄大于 18 岁的所有用户。

**前置条件**:
- 数据库中存在测试数据

**测试步骤**:
1. 调用 `database_query` 工具
2. 提供参数:
   ```json
   {
     "table": "users",
     "filters": {"age__gt": 18},
     "limit": 100
   }
   ```

**预期结果**:
```json
{
  "success": true,
  "data": [
    {"id": 1, "name": "Alice", "age": 25},
    {"id": 2, "name": "Bob", "age": 30}
  ],
  "count": 2
}
```

**验收标准**:
- ✅ 所有返回用户年龄 > 18
- ✅ 结果数量 <= limit
- ✅ 查询响应时间 < 100ms

**状态**: ⏳ 待验收

---

#### UAT-003: 数据更新验收 ⏳ 待验收
**场景描述**:  
作为 AI Agent，我需要更新特定用户的年龄。

**前置条件**:
- ENABLE_UPDATE=true
- 目标用户存在

**测试步骤**:
1. 调用 `database_update` 工具
2. 提供参数:
   ```json
   {
     "table": "users",
     "filters": {"name": "Alice"},
     "data": {"age": 26}
   }
   ```

**预期结果**:
```json
{
  "success": true,
  "updated_count": 1
}
```

**验收标准**:
- ✅ 数据库中 Alice 的年龄更新为 26
- ✅ 仅更新匹配的记录
- ✅ 返回正确的更新计数

**状态**: ⏳ 待验收

---

#### UAT-004: 数据删除验收 ⏳ 待验收
**场景描述**:  
作为 AI Agent，我需要删除测试用户。

**前置条件**:
- ENABLE_DELETE=true
- 目标用户存在

**测试步骤**:
1. 调用 `database_delete` 工具
2. 提供参数:
   ```json
   {
     "table": "users",
     "filters": {"name": "TestUser"}
   }
   ```

**预期结果**:
```json
{
  "success": true,
  "deleted_count": 1
}
```

**验收标准**:
- ✅ 用户已从数据库删除
- ✅ 返回正确的删除计数
- ✅ 查询该用户返回空结果

**状态**: ⏳ 待验收

---

### 2.2 多数据库支持验收

#### UAT-101: PostgreSQL 支持验收 ⏳ 待验收
**场景描述**:  
验证 PostgreSQL 数据库的完整 CRUD 功能。

**测试步骤**:
1. 设置 `DATABASE_URL=postgresql://user:pass@localhost:5432/testdb`
2. 依次执行 insert, query, update, delete 操作
3. 验证每个操作正常工作

**验收标准**:
- ✅ 所有 CRUD 操作成功
- ✅ 过滤器语法正确转换
- ✅ 返回结果格式一致

**状态**: ⏳ 待验收

---

#### UAT-102: MySQL 支持验收 ⏳ 待验收
**场景描述**:  
验证 MySQL 数据库的完整 CRUD 功能。

**验收标准**:
- ✅ 与 PostgreSQL 测试场景相同
- ✅ 连接池参数正确应用

**状态**: ⏳ 待验收

---

#### UAT-103: SQLite 支持验收 ⏳ 待验收
**场景描述**:  
验证 SQLite 文件数据库支持。

**测试步骤**:
1. 设置 `DATABASE_URL=sqlite:///test.db`
2. 执行 CRUD 操作

**验收标准**:
- ✅ 文件数据库正确创建
- ✅ 所有操作正常工作
- ✅ 支持异步文件 I/O

**状态**: ⏳ 待验收

---

#### UAT-104: MongoDB 支持验收 ⏳ 待验收
**场景描述**:  
验证 MongoDB 文档数据库支持。

**测试步骤**:
1. 设置 `DATABASE_URL=mongodb://localhost:27017/testdb`
2. 执行 CRUD 操作
3. 验证过滤器转换为 MongoDB 查询语法

**验收标准**:
- ✅ 文档插入/查询正常
- ✅ DSL 正确转换为 `$` 操作符
- ✅ 支持 MongoDB 特有类型 (ObjectId)

**状态**: ⏳ 待验收

---

#### UAT-105: Redis 支持验收 ⏳ 待验收
**场景描述**:  
验证 Redis 键值数据库支持。

**测试步骤**:
1. 设置 `DATABASE_URL=redis://localhost:6379/0`
2. 执行 CRUD 操作
3. 验证键前缀模式

**验收标准**:
- ✅ 键名格式为 `table:id`
- ✅ 查询通过 SCAN 实现
- ✅ 支持过期时间设置

**状态**: ⏳ 待验收

---

#### UAT-106: OpenSearch 支持验收 ⏳ 待验收
**场景描述**:  
验证 OpenSearch 搜索引擎支持。

**验收标准**:
- ✅ 基础文档操作正常
- ✅ 支持全文搜索
- ✅ 批量操作可用

**状态**: ⏳ 待验收

---

### 2.3 过滤器 DSL 验收

#### UAT-201: 基础操作符验收 ⏳ 待验收
**场景描述**:  
验证所有基础过滤器操作符正常工作。

**测试用例**:
| 操作符 | 输入 | 预期 SQL | 状态 |
|--------|------|----------|------|
| 等值 | `{"age": 25}` | `age = 25` | ⏳ |
| 大于 | `{"age__gt": 18}` | `age > 18` | ⏳ |
| 小于 | `{"age__lt": 60}` | `age < 60` | ⏳ |
| 包含 | `{"name__contains": "John"}` | `name LIKE '%John%'` | ⏳ |
| IN | `{"status__in": ["active"]}` | `status IN ('active')` | ⏳ |

**验收标准**:
- ✅ 所有操作符在 SQL 数据库正确转换
- ✅ MongoDB 正确映射为 `$` 操作符
- ✅ 查询结果符合预期

**状态**: ⏳ 待验收

---

#### UAT-202: 逻辑操作符验收 ⏳ 待验收
**场景描述**:  
验证 OR/AND 逻辑组合。

**测试步骤**:
1. 执行 OR 查询:
   ```json
   {
     "__or": [
       {"age": 25},
       {"age": 30}
     ]
   }
   ```
2. 执行 AND 查询:
   ```json
   {
     "age__gt": 18,
     "age__lt": 60
   }
   ```

**验收标准**:
- ✅ OR 逻辑正确执行
- ✅ AND 逻辑正确执行
- ✅ 复杂嵌套逻辑可用

**状态**: ⏳ 待验收

---

### 2.4 权限控制验收

#### UAT-301: INSERT 权限控制验收 ⏳ 待验收
**场景描述**:  
验证 ENABLE_INSERT 环境变量控制插入操作。

**测试步骤**:
1. 设置 `ENABLE_INSERT=false`
2. 尝试调用 `database_insert`

**预期结果**:
```json
{
  "success": false,
  "error": {
    "type": "PermissionError",
    "message": "INSERT operation is disabled"
  }
}
```

**验收标准**:
- ✅ 插入操作被拒绝
- ✅ 错误信息清晰
- ✅ 不影响其他操作

**状态**: ⏳ 待验收

---

#### UAT-302: DELETE 权限控制验收 ⏳ 待验收
**场景描述**:  
验证 ENABLE_DELETE 环境变量控制删除操作。

**验收标准**:
- ✅ DELETE 禁用时操作被拒绝
- ✅ 返回 PermissionError

**状态**: ⏳ 待验收

---

#### UAT-303: EXECUTE 权限控制验收 ⏳ 待验收
**场景描述**:  
验证 DANGEROUS_AGREE 环境变量控制 execute 接口。

**测试步骤**:
1. 设置 `DANGEROUS_AGREE=false`
2. 尝试调用 `database_execute`

**验收标准**:
- ✅ execute 接口不可见或调用失败
- ✅ 错误信息提示权限不足

**状态**: ⏳ 待验收

---

#### UAT-304: QUERY 始终可用验收 ⏳ 待验收
**场景描述**:  
验证 query 接口不受权限控制影响。

**测试步骤**:
1. 设置所有权限为 false
2. 调用 `database_query`

**验收标准**:
- ✅ 查询操作正常执行
- ✅ 返回正确结果

**状态**: ⏳ 待验收

---

### 2.5 安全验收

#### UAT-401: SQL 注入防护验收 ⏳ 待验收
**场景描述**:  
验证 SQL 注入攻击被阻止。

**测试步骤**:
1. 尝试注入恶意参数:
   ```json
   {
     "table": "users",
     "filters": {"id": "1; DROP TABLE users--"}
   }
   ```
2. 观察结果

**验收标准**:
- ✅ 恶意输入被安全处理
- ✅ 数据库不受影响
- ✅ 使用参数化查询

**状态**: ⏳ 待验收

---

#### UAT-402: 危险命令拦截验收 ⏳ 待验收
**场景描述**:  
验证危险命令被拦截。

**测试步骤**:
1. 设置 `DANGEROUS_AGREE=true`
2. 尝试执行 `DROP TABLE users`

**预期结果**:
```json
{
  "success": false,
  "error": {
    "type": "PermissionError",
    "message": "Dangerous operation: DROP"
  }
}
```

**验收标准**:
- ✅ DROP 命令被拒绝
- ✅ TRUNCATE 命令被拒绝
- ✅ ALTER 命令被拒绝（可配置）
- ✅ 审计日志记录尝试

**状态**: ⏳ 待验收

---

#### UAT-403: 审计日志验收 ⏳ 待验收
**场景描述**:  
验证所有 execute 调用被记录。

**测试步骤**:
1. 执行 `database_execute` 命令
2. 检查审计日志文件

**验收标准**:
- ✅ 日志包含时间戳
- ✅ 日志包含完整命令
- ✅ 日志包含参数
- ✅ 日志包含执行结果

**状态**: ⏳ 待验收

---

### 2.6 高级功能验收

#### UAT-501: 事务支持验收 (SQL) ⏳ 待验收
**场景描述**:  
验证 SQL 数据库的事务支持。

**测试步骤**:
1. 调用 `database_advanced_query`:
   ```json
   {
     "operation": "transaction",
     "operations": [
       {"type": "insert", "table": "users", "data": {...}},
       {"type": "update", "table": "orders", ...}
     ]
   }
   ```

**验收标准**:
- ✅ 所有操作在同一事务中执行
- ✅ 失败时自动回滚
- ✅ 成功时全部提交

**状态**: ⏳ 待验收

---

#### UAT-502: MongoDB 聚合管道验收 ⏳ 待验收
**场景描述**:  
验证 MongoDB 聚合功能。

**测试步骤**:
1. 调用 `database_advanced_query`:
   ```json
   {
     "operation": "aggregate",
     "collection": "orders",
     "pipeline": [
       {"$match": {"status": "completed"}},
       {"$group": {"_id": "$user_id", "total": {"$sum": "$amount"}}}
     ]
   }
   ```

**验收标准**:
- ✅ 聚合管道正确执行
- ✅ 返回聚合结果
- ✅ 复杂管道支持

**状态**: ⏳ 待验收

---

#### UAT-503: Redis Lua 脚本验收 ⏳ 待验收
**场景描述**:  
验证 Redis Lua 脚本执行。

**验收标准**:
- ✅ Lua 脚本正确执行
- ✅ 原子性保证
- ✅ 返回脚本结果

**状态**: ⏳ 待验收

---

### 2.7 配置灵活性验收

#### UAT-601: DATABASE_URL 解析验收 ⏳ 待验收
**场景描述**:  
验证各种 DATABASE_URL 格式正确解析。

**测试用例**:
| URL 格式 | 解析结果 | 状态 |
|----------|---------|------|
| `postgresql://localhost/db` | scheme=postgresql, host=localhost | ⏳ |
| `mysql://user:pass@host:3306/db` | 包含认证信息 | ⏳ |
| `sqlite:///path/to/db.sqlite` | 文件路径 | ⏳ |
| `mongodb+srv://cluster.mongodb.net/db` | SRV 记录 | ⏳ |

**验收标准**:
- ✅ 所有格式正确解析
- ✅ 错误格式返回清晰提示

**状态**: ⏳ 待验收

---

#### UAT-602: 连接池参数验收 ⏳ 待验收
**场景描述**:  
验证 URL 中的连接池参数生效。

**测试步骤**:
1. 设置 URL:
   ```
   postgresql://localhost/db?pool_size=20&max_overflow=10
   ```
2. 执行并发查询
3. 检查连接池配置

**验收标准**:
- ✅ pool_size 参数生效
- ✅ max_overflow 参数生效
- ✅ 连接池正常工作

**状态**: ⏳ 待验收

---

#### UAT-603: 方法参数覆盖验收 ⏳ 待验收
**场景描述**:  
验证方法参数可以覆盖 DATABASE_URL 配置。

**测试步骤**:
1. 设置 `DATABASE_URL=postgresql://localhost/db1`
2. 调用 query 时指定 `database="db2"`

**验收标准**:
- ✅ 查询使用 db2 而非 db1
- ✅ 其他连接参数继承

**状态**: ⏳ 待验收

---

## 3. 性能验收

### 3.1 QPS 验收 ⏳ 待验收
**场景描述**:  
验证单实例 QPS 达到 200。

**测试步骤**:
1. 使用基准测试工具
2. 执行 1 分钟持续查询
3. 计算 QPS

**验收标准**:
- ✅ QPS >= 200
- ✅ 无错误发生
- ✅ 内存使用稳定

**状态**: ⏳ 待验收

---

### 3.2 延迟验收 ⏳ 待验收
**场景描述**:  
验证 P95 延迟 < 100ms。

**测试步骤**:
1. 执行 1000 次查询
2. 计算 P95 延迟

**验收标准**:
- ✅ P95 延迟 < 100ms (本地数据库)
- ✅ P99 延迟 < 200ms
- ✅ 平均延迟 < 50ms

**状态**: ⏳ 待验收

---

### 3.3 并发性能验收 ⏳ 待验收
**场景描述**:  
验证高并发场景下稳定性。

**测试步骤**:
1. 启动 50 个并发查询
2. 持续 1 分钟
3. 检查错误率

**验收标准**:
- ✅ 错误率 < 0.1%
- ✅ 连接池未耗尽
- ✅ 无连接泄漏

**状态**: ⏳ 待验收

---

## 4. 用户体验验收

### 4.1 错误信息友好性验收 ⏳ 待验收
**场景描述**:  
验证错误信息清晰易懂。

**测试用例**:
| 错误场景 | 错误信息示例 | 状态 |
|----------|-------------|------|
| 连接失败 | "Unable to connect to postgresql://localhost:5432/db: Connection refused" | ⏳ |
| 权限不足 | "INSERT operation is disabled. Set ENABLE_INSERT=true to enable." | ⏳ |
| 表不存在 | "Table 'users' does not exist in database 'testdb'" | ⏳ |

**验收标准**:
- ✅ 错误类型明确
- ✅ 包含解决建议
- ✅ 不暴露敏感信息

**状态**: ⏳ 待验收

---

### 4.2 工具描述清晰性验收 ⏳ 待验收
**场景描述**:  
验证 MCP 工具描述对 AI 友好。

**测试步骤**:
1. 查看 `database_query` 工具描述
2. 让 AI 理解并使用工具

**验收标准**:
- ✅ 描述简洁明了
- ✅ 参数说明完整
- ✅ 包含使用示例

**状态**: ⏳ 待验收

---

## 5. 文档验收

### 5.1 API 文档验收 ⏳ 待验收
**场景描述**:  
验证 API 文档完整可用。

**验收标准**:
- ✅ 所有接口有描述
- ✅ 所有参数有说明
- ✅ 包含代码示例
- ✅ 包含错误处理示例

**状态**: ⏳ 待验收

---

### 5.2 部署文档验收 ⏳ 待验收
**场景描述**:  
按照部署文档完成安装和配置。

**测试步骤**:
1. 从零开始按文档操作
2. 完成安装和配置
3. 运行示例

**验收标准**:
- ✅ 文档步骤清晰
- ✅ 无遗漏步骤
- ✅ 示例可运行

**状态**: ⏳ 待验收

---

### 5.3 故障排查文档验收 ⏳ 待验收
**场景描述**:  
验证常见问题有解决方案。

**验收标准**:
- ✅ 涵盖常见错误
- ✅ 提供排查步骤
- ✅ 包含解决方案

**状态**: ⏳ 待验收

---

## 6. 端到端用户流程验收

### 6.1 AI 数据分析流程 ⏳ 待验收
**场景描述**:  
AI Agent 完成数据分析任务。

**完整流程**:
1. AI 查询用户表获取数据
2. AI 分析数据并识别趋势
3. AI 插入分析结果到 reports 表
4. AI 查询验证结果已保存

**验收标准**:
- ✅ 整个流程无人工干预
- ✅ 每步操作成功
- ✅ 结果准确可靠

**状态**: ⏳ 待验收

---

### 6.2 数据迁移流程 ⏳ 待验收
**场景描述**:  
开发者使用 SDK 迁移数据。

**完整流程**:
1. 从 PostgreSQL 读取数据
2. 转换数据格式
3. 写入 MongoDB
4. 验证数据一致性

**验收标准**:
- ✅ 数据完整迁移
- ✅ 无数据丢失
- ✅ 性能满足要求

**状态**: ⏳ 待验收

---

### 6.3 多数据库协同流程 ⏳ 待验收
**场景描述**:  
AI 同时操作多个数据库。

**完整流程**:
1. 从 PostgreSQL 查询用户信息
2. 从 Redis 查询缓存数据
3. 从 MongoDB 查询日志
4. 综合分析并返回结果

**验收标准**:
- ✅ 可以同时连接多个数据库
- ✅ 数据正确聚合
- ✅ 性能可接受

**状态**: ⏳ 待验收

---

## 7. 验收检查清单

### 7.1 功能完整性检查

- [ ] ⏳ 所有 7 种数据库的 CRUD 操作可用
- [ ] ⏳ 过滤器 DSL 所有操作符正常工作
- [ ] ⏳ 权限控制机制正确生效
- [ ] ⏳ 安全检查有效防护
- [ ] ⏳ 高级功能接口可用
- [ ] ⏳ 配置灵活性满足需求

### 7.2 性能指标检查

- [ ] ⏳ QPS >= 200
- [ ] ⏳ P95 延迟 < 100ms
- [ ] ⏳ 并发 50 无错误

### 7.3 安全性检查

- [ ] ⏳ SQL 注入攻击被阻止
- [ ] ⏳ 危险命令被拦截
- [ ] ⏳ 审计日志完整

### 7.4 用户体验检查

- [ ] ⏳ 错误信息友好
- [ ] ⏳ 工具描述清晰
- [ ] ⏳ 文档完整可用

### 7.5 端到端流程检查

- [ ] ⏳ AI 数据分析流程通过
- [ ] ⏳ 数据迁移流程通过
- [ ] ⏳ 多数据库协同流程通过

---

## 8. 验收会议

### 8.1 验收会议安排

**会议时间**: Week 7 末  
**参与人员**: 
- 产品经理
- 技术负责人
- QA 负责人
- 开发团队

**议程**:
1. 功能演示 (30分钟)
2. 测试报告回顾 (20分钟)
3. 问题讨论 (20分钟)
4. 验收决策 (10分钟)

**状态**: ⏳ 待安排

---

### 8.2 验收标准

**通过条件**:
- ✅ 所有 P0 验收点通过
- ✅ P1 验收点通过率 >= 90%
- ✅ 无 Critical 缺陷
- ✅ High 级别缺陷 <= 2 个

**状态**: ⏳ 待评估

---

## 9. 验收签字

### 9.1 验收签字表

| 角色 | 姓名 | 签字 | 日期 | 状态 |
|------|------|------|------|------|
| 产品负责人 | | | | ⏳ 待签字 |
| 技术负责人 | | | | ⏳ 待签字 |
| QA 负责人 | | | | ⏳ 待签字 |
| 项目经理 | | | | ⏳ 待签字 |

---

## 附录

### A. 验收环境配置

**硬件要求**:
- CPU: 2核
- 内存: 4GB
- 磁盘: 20GB

**软件要求**:
- Python 3.10+
- Docker (用于数据库)
- MCP Client

### B. 验收数据准备

**测试数据集**:
- 用户表: 1000 条记录
- 订单表: 5000 条记录
- 日志表: 10000 条记录

**状态**: ⏳ 待准备
