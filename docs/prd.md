# 产品需求文档 (PRD)

**项目名称**: MCP Database SDK  
**版本**: v1.0  
**创建日期**: 2024-01-07  
**文档状态**: ⏳ 待评审

---

## 1. 产品概述

### 1.1 产品定位
MCP Database SDK 是一个为大语言模型（LLM）提供统一数据库操作能力的 Python SDK，通过 MCP (Model Context Protocol) 协议将多种数据库的 CRUD 操作封装为标准接口，使 AI 能够安全、高效地访问和操作数据。

### 1.2 目标用户
- **主要用户**: 大语言模型 (如 Claude, GPT-4 等)
- **次要用户**: 需要统一数据库接口的 Python 开发者
- **使用场景**: AI Agent 数据查询、自动化数据分析、智能数据管理

### 1.3 核心价值
- **统一接口**: 一套 API 操作 7+ 种数据库
- **安全可控**: 细粒度权限控制，防止误操作
- **AI 友好**: 为 LLM 优化的接口设计，支持自然语言转换

---

## 2. 功能需求

### 2.1 核心功能需求

#### FR-001: 统一 CRUD 接口 ⏳ 待开发
**用户故事**:  
> 作为 AI Agent，我希望使用统一的接口操作不同类型的数据库，以便我不需要学习每种数据库的特定语法。

**需求描述**:
- 提供 `insert`, `delete`, `update`, `query` 四个基础接口
- 接口参数标准化，支持通过 `table` + `filters` 方式操作数据
- 支持跨数据库的统一过滤器语法（DSL）

**验收标准**:
- ✅ 所有支持的数据库都能通过统一接口完成基础 CRUD
- ✅ 接口返回结构一致（统一 Result 对象）
- ✅ 错误信息统一且明确

**优先级**: P0 (关键)

---

#### FR-002: 多数据库支持 ⏳ 待开发
**用户故事**:  
> 作为开发者，我希望通过 DATABASE_URL 环境变量轻松切换数据库，以便在不同环境使用不同存储。

**需求描述**:
支持以下数据库类型：
- **关系型**: PostgreSQL, MySQL, SQLite
- **文档型**: MongoDB
- **键值型**: Redis
- **搜索引擎**: OpenSearch
- **云服务**: Supabase

**验收标准**:
- ✅ 通过 DATABASE_URL 自动识别数据库类型
- ✅ 每种数据库的基础 CRUD 功能完整可用
- ✅ 连接池配置可通过 URL 参数设置

**优先级**: P0 (关键)

---

#### FR-003: 权限控制机制 ⏳ 待开发
**用户故事**:  
> 作为系统管理员，我希望通过环境变量控制哪些操作可被执行，以便防止 AI 误操作敏感数据。

**需求描述**:
- `ENABLE_INSERT`: 控制插入操作权限
- `ENABLE_DELETE`: 控制删除操作权限
- `ENABLE_UPDATE`: 控制更新操作权限
- `DANGEROUS_AGREE`: 控制 execute 接口可见性
- `query` 接口始终启用（只读操作）

**验收标准**:
- ✅ 环境变量未设置时，危险操作默认禁用
- ✅ 禁用状态下调用接口返回 `PermissionError`
- ✅ 错误信息明确指出权限不足原因

**优先级**: P0 (关键)

---

#### FR-004: 直接命令执行接口 ⏳ 待开发
**用户故事**:  
> 作为高级用户，我希望在必要时直接执行数据库原生命令，以便使用特定数据库的高级功能。

**需求描述**:
- 提供 `execute` 接口用于执行原生数据库命令
- 仅在 `DANGEROUS_AGREE=true` 时对 AI 可见
- 强制参数化查询，防止 SQL 注入
- 禁止执行危险命令（DROP, TRUNCATE 等）

**验收标准**:
- ✅ `DANGEROUS_AGREE=false` 时接口不可见或调用失败
- ✅ 非参数化查询被拒绝
- ✅ 危险命令执行被阻止并记录日志
- ✅ 所有 execute 调用都有审计日志

**优先级**: P1 (重要)

---

#### FR-005: 高级查询接口 ⏳ 待开发
**用户故事**:  
> 作为 AI Agent，我希望能够使用数据库特有的高级功能（如聚合、事务），以便完成复杂的数据处理任务。

**需求描述**:
提供 `advanced_query` 接口暴露数据库特定能力：
- **SQL**: 事务、多表 JOIN
- **MongoDB**: 聚合管道、全文检索
- **Redis**: Lua 脚本、发布订阅

**验收标准**:
- ✅ 通过 `operation` 参数区分不同高级功能
- ✅ 每种数据库至少支持 2 种高级操作
- ✅ 提供 `get_capabilities()` 接口查询支持的功能

**优先级**: P1 (重要)

---

#### FR-006: 灵活连接配置 ⏳ 待开发
**用户故事**:  
> 作为开发者，我希望能够在调用接口时临时覆盖数据库连接，以便在同一进程中操作多个数据库。

**需求描述**:
- 支持通过 DATABASE_URL 环境变量设置默认连接
- 接口参数支持 `database` 可选参数覆盖连接
- 配置优先级：方法参数 > 环境变量 > 默认值

**验收标准**:
- ✅ DATABASE_URL 未设置时返回清晰错误
- ✅ 方法参数中的 database 能正确覆盖默认连接
- ✅ 连接字符串格式错误时提供友好提示

**优先级**: P1 (重要)

---

### 2.2 过滤器 DSL 需求

#### FR-007: 统一过滤器语法 ⏳ 待开发
**用户故事**:  
> 作为 AI，我希望使用简单一致的语法表达查询条件，而不需要学习 SQL/MongoDB 等不同语法。

**支持的操作符**:
| 操作符 | 示例 | 说明 |
|--------|------|------|
| 等值 | `{"age": 25}` | 精确匹配 |
| 比较 | `{"age__gt": 18}` | 大于、小于、大于等于、小于等于 |
| 包含 | `{"name__contains": "John"}` | 字符串模糊匹配 |
| 范围 | `{"age__between": [18, 30]}` | 值在范围内 |
| 列表 | `{"status__in": ["active", "pending"]}` | 值在列表中 |
| 空值 | `{"email__is_null": true}` | 字段为空 |
| 逻辑 | `{"__or": [{...}, {...}]}` | OR 逻辑 |

**验收标准**:
- ✅ 所有操作符在 SQL 数据库上正确转换
- ✅ MongoDB 能正确映射为 `$` 操作符
- ✅ Redis 支持基础等值查询（内存过滤）

**优先级**: P0 (关键)

---

## 3. 非功能需求

### 3.1 性能需求

#### NFR-001: 性能指标 ⏳ 待验证
- **QPS 目标**: 200 请求/秒（单实例）
- **延迟要求**: P95 < 100ms（不含网络延迟）
- **连接池**: 支持连接复用，避免频繁创建连接

**验收标准**:
- ✅ 基准测试达到 200 QPS
- ✅ P95 延迟 < 100ms（本地数据库）
- ✅ 连接池配置正确生效

---

### 3.2 可靠性需求

#### NFR-002: 错误处理 ⏳ 待实现
- 统一异常体系，所有数据库错误转换为标准异常
- 连接失败自动重试（可配置次数）
- 超时机制保护（查询、连接超时）

**验收标准**:
- ✅ 所有异常都继承自 `DatabaseError`
- ✅ 异常信息包含原始错误和转换后的标准信息
- ✅ 超时配置在 URL 参数中可设置

---

### 3.3 安全性需求

#### NFR-003: 安全防护 ⏳ 待实现
- SQL 注入防护（强制参数化查询）
- 危险操作拦截（DROP, TRUNCATE 等）
- 审计日志记录（execute 接口调用）

**验收标准**:
- ✅ 非参数化查询被拒绝
- ✅ 危险命令执行失败并记录日志
- ✅ 审计日志包含完整上下文（时间、命令、参数）

---

### 3.4 可扩展性需求

#### NFR-004: 插件化架构 ⏳ 待实现
- 新增数据库支持只需实现 `DatabaseAdapter` 接口
- 通过工厂模式自动识别和加载适配器
- 支持第三方扩展（通过 entry_points）

**验收标准**:
- ✅ 添加新数据库无需修改核心代码
- ✅ 适配器注册机制清晰可用
- ✅ 提供适配器开发文档

---

### 3.5 可维护性需求

#### NFR-005: 代码质量 ⏳ 待实现
- 类型注解覆盖率 > 90%
- 单元测试覆盖率 > 80%
- 代码符合 PEP 8 规范

**验收标准**:
- ✅ mypy 类型检查无错误
- ✅ pytest 覆盖率报告达标
- ✅ ruff/black 格式化通过

---

## 4. MCP 接口设计

### 4.1 暴露给 AI 的工具

#### Tool-001: database_query ⏳ 待开发
**描述**: 查询数据库数据（只读操作）

**参数**:
```json
{
  "table": "users",
  "filters": {"age__gt": 18},
  "limit": 10,
  "offset": 0
}
```

---

#### Tool-002: database_insert ⏳ 待开发
**描述**: 插入数据（需 ENABLE_INSERT=true）

**参数**:
```json
{
  "table": "users",
  "data": {"name": "Alice", "age": 25}
}
```

---

#### Tool-003: database_update ⏳ 待开发
**描述**: 更新数据（需 ENABLE_UPDATE=true）

---

#### Tool-004: database_delete ⏳ 待开发
**描述**: 删除数据（需 ENABLE_DELETE=true）

---

#### Tool-005: database_execute ⏳ 待开发
**描述**: 执行原生命令（需 DANGEROUS_AGREE=true）

---

#### Tool-006: database_advanced_query ⏳ 待开发
**描述**: 执行高级查询（事务、聚合等）

---

#### Tool-007: get_database_capabilities ⏳ 待开发
**描述**: 查询当前数据库支持的功能

---

## 5. 验收标准总览

### 5.1 功能验收
- [ ] ⏳ 待验收: 所有 7 种数据库的基础 CRUD 可用
- [ ] ⏳ 待验收: 权限控制机制生效
- [ ] ⏳ 待验收: 过滤器 DSL 覆盖常用场景
- [ ] ⏳ 待验收: execute 接口安全检查通过

### 5.2 性能验收
- [ ] ⏳ 待验收: 基准测试达到 200 QPS
- [ ] ⏳ 待验收: P95 延迟 < 100ms

### 5.3 安全验收
- [ ] ⏳ 待验收: SQL 注入攻击测试通过
- [ ] ⏳ 待验收: 危险命令拦截测试通过
- [ ] ⏳ 待验收: 审计日志完整性验证

### 5.4 文档验收
- [ ] ⏳ 待验收: API 文档完整（所有接口有示例）
- [ ] ⏳ 待验收: 适配器开发指南可用
- [ ] ⏳ 待验收: 部署文档验证通过

---

## 6. 里程碑

| 里程碑 | 目标日期 | 状态 |
|--------|---------|------|
| MVP - 核心接口 + SQLite | Week 2 | ⏳ 待开始 |
| 多数据库支持 | Week 5 | ⏳ 待开始 |
| 安全加固 | Week 6 | ⏳ 待开始 |
| 生产就绪 | Week 7 | ⏳ 待开始 |

---

## 7. 风险与约束

### 7.1 技术风险
- **风险**: 异步 ORM 兼容性问题
- **应对**: 提前验证 asyncpg/motor，准备降级方案

### 7.2 安全风险
- **风险**: execute 接口被绕过
- **应对**: 多层防护 + 外部安全审计

### 7.3 约束条件
- Python 版本 >= 3.10
- 仅支持 MCP 协议（不提供 REST API）
- 不支持跨数据库事务

---

## 附录

### A. 术语表
- **MCP**: Model Context Protocol，LLM 与工具交互的协议
- **DSL**: Domain Specific Language，领域特定语言
- **ORM**: Object-Relational Mapping，对象关系映射

### B. 参考文档
- MCP 协议规范: https://modelcontextprotocol.io
- SQLAlchemy 文档: https://docs.sqlalchemy.org
- Motor (MongoDB): https://motor.readthedocs.io
